<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Cadence</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, var(--primary), var(--secondary));">
        <div class="modal-content" style="position:relative;max-width:400px;margin:1rem;">
            <div style="text-align:center;margin-bottom:2rem;">
                <h1 style="font-size:3rem;margin-bottom:0.5rem;">üîê</h1>
                <h1 style="font-size:1.75rem;margin-bottom:0.25rem;">Reset Password</h1>
                <p style="color:var(--text-secondary);font-size:0.875rem;">Enter your new password</p>
            </div>
            
            <form id="resetPasswordForm" onsubmit="handleResetPassword(event)">
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" required minlength="6" placeholder="At least 6 characters" autofocus>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" required minlength="6" placeholder="Re-enter password">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%;margin-top:1rem;" id="resetButton">
                    Reset Password
                </button>
            </form>
            
            <div id="resetError" style="display:none;padding:1rem;background:#fee;border-radius:8px;color:#e74c3c;margin-top:1rem;font-size:0.875rem;">
                <span id="resetErrorText"></span>
            </div>
            
            <div id="resetSuccess" style="display:none;padding:1rem;background:#d4edda;border-radius:8px;color:#155724;margin-top:1rem;font-size:0.875rem;">
                <span id="resetSuccessText"></span>
            </div>
            
            <div id="resetLoading" style="display:none;text-align:center;margin-top:1rem;">
                <div class="spinner" style="margin:0 auto;"></div>
                <p style="color:var(--text-secondary);font-size:0.875rem;margin-top:0.5rem;">Updating password...</p>
            </div>
            
            <p style="text-align:center;margin-top:1.5rem;">
                <a href="./login.html" style="color:var(--primary);text-decoration:none;font-size:0.875rem;">
                    ‚Üê Back to login
                </a>
            </p>
        </div>
    </div>

    <script type="module">
        import { SUPABASE_URL, SUPABASE_KEY } from './js/config.js';
        
        // Check for access token in URL hash (Supabase sends it after email click)
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const type = hashParams.get('type');
        
        if (!accessToken || type !== 'recovery') {
            // No valid reset token
            document.getElementById('resetError').style.display = 'block';
            document.getElementById('resetErrorText').textContent = 'Invalid or expired reset link. Please request a new one.';
            document.getElementById('resetPasswordForm').style.display = 'none';
        }
        
        window.handleResetPassword = async (event) => {
            event.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('resetError');
            const errorText = document.getElementById('resetErrorText');
            const successDiv = document.getElementById('resetSuccess');
            const successText = document.getElementById('resetSuccessText');
            const loadingDiv = document.getElementById('resetLoading');
            const resetButton = document.getElementById('resetButton');
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                errorDiv.style.display = 'block';
                errorText.textContent = 'Passwords do not match';
                return;
            }
            
            // Hide messages, show loading
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            loadingDiv.style.display = 'block';
            resetButton.disabled = true;
            
            try {
                // Update password using the access token
                const response = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
                    method: 'PUT',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        password: newPassword 
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.msg || result.error_description || 'Failed to reset password');
                }
                
                // Success!
                loadingDiv.style.display = 'none';
                successDiv.style.display = 'block';
                successText.textContent = 'Password updated successfully! Redirecting to login...';
                
                // Store the new token and redirect
                if (result.access_token) {
                    localStorage.setItem('supabase.auth.token', result.access_token);
                }
                
                // Redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = './login.html';
                }, 2000);
                
            } catch (error) {
                console.error('Reset password error:', error);
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                errorText.textContent = error.message || 'Failed to reset password';
                resetButton.disabled = false;
            }
        };
    </script>
</body>
</html>