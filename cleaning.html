<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleaning Tasks - Cadence</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="page-wrapper">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <a href="index.html" class="logo">Cadence</a>
                    
                    <nav class="nav-menu" id="navMenu">
                        <a href="index.html" class="nav-link">Dashboard</a>
                        <a href="cleaning.html" class="nav-link active">Cleaning</a>
                        <a href="settings.html" class="nav-link">Settings</a>
                        <a href="components.html" class="nav-link">Components</a>
                    </nav>

                    <button class="btn btn-secondary" id="logoutBtn" style="display: none;">
                        <span>Logout</span>
                        <span>🚪</span>
                    </button>

                    <button class="mobile-nav-toggle" id="mobileToggle">☰</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="content-wrapper">
            <div class="container">
                <!-- Page Header -->
                <section class="page-header">
                    <div class="header-content-main">
                        <h1>Cleaning Tasks</h1>
                        <p class="page-subtitle">Manage your home cleaning schedule</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" id="smartScheduleBtn">
                            <span>⚡</span>
                            <span>Smart Schedule</span>
                        </button>
                        <button class="btn btn-primary" id="addTaskBtn">
                            <span>+</span>
                            <span>Add Task</span>
                        </button>
                    </div>
                </section>

                <!-- Filter Bar -->
                <div class="filter-bar glass-card">
                    <div class="filter-tabs">
                        <button class="filter-tab active" data-filter="all">All Tasks</button>
                        <button class="filter-tab" data-filter="overdue">Overdue</button>
                        <button class="filter-tab" data-filter="due-soon">Due Soon</button>
                        <button class="filter-tab" data-filter="on-track">On Track</button>
                    </div>
                    <div class="filter-search">
                        <input 
                            type="text" 
                            id="searchInput" 
                            class="form-input" 
                            placeholder="Search tasks..."
                        >
                    </div>
                </div>

                <!-- Tasks List -->
                <section class="tasks-main" id="tasksContainer">
                    <!-- Loading skeleton -->
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                </section>
            </div>
        </main>
    </div>

    <!-- Add/Edit Task Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Task</h3>
                <button class="modal-close" onclick="closeTaskModal()">×</button>
            </div>
            <form id="taskForm" autocomplete="off">
                <input type="hidden" id="taskId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="taskName">Task Name *</label>
                        <input 
                            type="text" 
                            id="taskName" 
                            class="form-input" 
                            placeholder="e.g., Clean kitchen counters"
                            required
                            autocomplete="off"
                        >
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="floor">Floor</label>
                        <select id="floor" class="form-input">
                            <option value="">Select floor</option>
                            <option value="Main Floor">Main Floor</option>
                            <option value="Upstairs">Upstairs</option>
                            <option value="Basement">Basement</option>
                            <option value="Garage">Garage</option>
                            <option value="Outdoor">Outdoor</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="category">Category</label>
                        <select id="category" class="form-input">
                            <option value="">Select category</option>
                            <option value="Kitchen">Kitchen</option>
                            <option value="Bathroom">Bathroom</option>
                            <option value="Bedroom">Bedroom</option>
                            <option value="Living Room">Living Room</option>
                            <option value="Laundry">Laundry</option>
                            <option value="General">General</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="cadence">Cadence (days) *</label>
                        <input 
                            type="number" 
                            id="cadence" 
                            class="form-input" 
                            placeholder="7"
                            min="1"
                            required
                        >
                        <small class="form-help">How often should this task be done?</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="timeEstimate">Time (minutes)</label>
                        <input 
                            type="number" 
                            id="timeEstimate" 
                            class="form-input" 
                            placeholder="15"
                            min="5"
                            value="15"
                        >
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="effort">Effort Level</label>
                        <select id="effort" class="form-input">
                            <option value="Low">Low - Quick & Easy</option>
                            <option value="Medium" selected>Medium - Moderate Work</option>
                            <option value="High">High - Intensive</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="priority">Priority</label>
                        <input 
                            type="number" 
                            id="priority" 
                            class="form-input" 
                            placeholder="100"
                            min="1"
                            max="1000"
                            value="100"
                        >
                        <small class="form-help">Higher = more important</small>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveTaskBtn">
                        Save Task
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3>Delete Task?</h3>
                <button class="modal-close" onclick="closeDeleteModal()">×</button>
            </div>
            <p style="margin-bottom: var(--space-6); color: var(--text-secondary);">
                Are you sure you want to delete "<span id="deleteTaskName"></span>"? This action cannot be undone.
            </p>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">
                    Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    Delete Task
                </button>
            </div>
        </div>
    </div>

    <!-- Feedback Button -->
    <button class="fab" onclick="showFeedbackModal()" title="Send Feedback">
        💬
    </button>

    <!-- Feedback Modal -->
    <div class="modal" id="feedbackModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Send Feedback</h3>
                <button class="modal-close" onclick="closeFeedbackModal()">×</button>
            </div>
            <form id="feedbackForm">
                <div class="form-group">
                    <label class="form-label">What kind of feedback?</label>
                    <select id="feedbackType" class="form-input" required>
                        <option value="bug">🐛 Bug Report</option>
                        <option value="feature">💡 Feature Request</option>
                        <option value="feedback">💬 General Feedback</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tell us more</label>
                    <textarea 
                        id="feedbackText" 
                        class="form-input" 
                        rows="4" 
                        required
                        placeholder="Be as detailed as you'd like..."
                    ></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeFeedbackModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Send Feedback
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initAuthCheck } from './js/auth.js';
        import { tasks, feedback } from './js/api.js';
        import { 
            showToast, 
            getTaskStatus,
            getStatusIcon,
            getStatusColor,
            getNextDueDate,
            initApp 
        } from './js/app.js';

        // Check authentication
        const user = await initAuthCheck();
        document.getElementById('logoutBtn').style.display = 'flex';

        // Global variables
        let allTasks = [];
        let currentFilter = 'all';
        let taskToDelete = null;

        // Load all tasks
        async function loadTasks() {
            try {
                const result = await tasks.getAll();
                
                if (result.error) {
                    throw result.error;
                }

                allTasks = result.data || [];
                renderTasks();
            } catch (error) {
                console.error('Error loading tasks:', error);
                showToast('Failed to load tasks', 'error');
            }
        }

        // Render tasks based on current filter
        function renderTasks() {
            const container = document.getElementById('tasksContainer');
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();

            // Filter tasks
            let filteredTasks = allTasks.filter(task => {
                // Search filter
                if (searchQuery && !task.task_name.toLowerCase().includes(searchQuery)) {
                    return false;
                }

                // Status filter
                if (currentFilter !== 'all') {
                    const status = getTaskStatus(task);
                    if (status !== currentFilter) {
                        return false;
                    }
                }

                return true;
            });

            // Empty state
            if (filteredTasks.length === 0) {
                const emptyMessage = currentFilter === 'all' && !searchQuery
                    ? "No tasks yet! Click 'Add Task' to get started."
                    : "No tasks found matching your filters.";

                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <h3 class="empty-state-title">No Tasks</h3>
                        <p class="empty-state-text">${emptyMessage}</p>
                        ${currentFilter === 'all' && !searchQuery ? `
                            <button class="btn btn-primary" onclick="document.getElementById('addTaskBtn').click()" 
                                    style="margin-top: var(--space-4);">
                                Add Your First Task
                            </button>
                        ` : ''}
                    </div>
                `;
                return;
            }

            // Group tasks by status
            const grouped = {
                overdue: [],
                'due-soon': [],
                'on-track': []
            };

            filteredTasks.forEach(task => {
                const status = getTaskStatus(task);
                grouped[status].push(task);
            });

            // Render grouped tasks
            let html = '';

            if (grouped.overdue.length > 0) {
                html += renderTaskGroup('Overdue', grouped.overdue, 'danger');
            }

            if (grouped['due-soon'].length > 0) {
                html += renderTaskGroup('Due Soon', grouped['due-soon'], 'warning');
            }

            if (grouped['on-track'].length > 0) {
                html += renderTaskGroup('On Track', grouped['on-track'], 'success');
            }

            container.innerHTML = html;
        }

        // Render a group of tasks
        function renderTaskGroup(title, taskList, colorClass) {
            return `
                <div class="task-group">
                    <div class="group-header">
                        <h2 class="group-title">${title}</h2>
                        <span class="group-count">${taskList.length} ${taskList.length === 1 ? 'task' : 'tasks'}</span>
                    </div>
                    <div class="tasks-grid">
                        ${taskList.map(task => renderTaskCard(task, colorClass)).join('')}
                    </div>
                </div>
            `;
        }

        // Render individual task card
        function renderTaskCard(task, colorClass) {
            const status = getTaskStatus(task);
            const dueText = getNextDueDate(task.last_completed, task.cadence);
            const statusIcon = getStatusIcon(status);

            return `
                <div class="task-card glass-card-hover" data-task-id="${task.id}">
                    <div class="task-header">
                        <div class="task-status status-${colorClass}">
                            ${statusIcon}
                        </div>
                        <h3 class="task-title">${task.task_name}</h3>
                    </div>
                    
                    <div class="task-details">
                        ${task.floor ? `<div class="task-meta"><span class="meta-icon">📍</span>${task.floor}</div>` : ''}
                        ${task.category ? `<div class="task-meta"><span class="meta-icon">🏷️</span>${task.category}</div>` : ''}
                        <div class="task-meta"><span class="meta-icon">🔄</span>Every ${task.cadence} days</div>
                        <div class="task-meta"><span class="meta-icon">⏱️</span>${task.time_estimate || 15} min</div>
                    </div>

                    <div class="task-due">
                        ${dueText}
                    </div>

                    <div class="task-actions">
                        <button class="btn btn-sm btn-success" onclick="completeTask(${task.id})" title="Mark Complete">
                            ✓ Complete
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="editTask(${task.id})" title="Edit">
                            ✏️
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="confirmDelete(${task.id}, '${task.task_name.replace(/'/g, "\\'")}')title="Delete">
                            🗑️
                        </button>
                    </div>
                </div>
            `;
        }

        // Complete task
        window.completeTask = async (taskId) => {
            try {
                const result = await tasks.complete(taskId);
                
                if (result.error) {
                    throw result.error;
                }

                showToast('Task completed! Great work! 🎉', 'success');
                await loadTasks();
            } catch (error) {
                console.error('Error completing task:', error);
                showToast('Failed to complete task', 'error');
            }
        };

        // Edit task
        window.editTask = async (taskId) => {
            try {
                const result = await tasks.getById(taskId);
                
                if (result.error || !result.data) {
                    throw new Error('Task not found');
                }

                const task = result.data;

                // Populate form
                document.getElementById('modalTitle').textContent = 'Edit Task';
                document.getElementById('taskId').value = task.id;
                document.getElementById('taskName').value = task.task_name;
                document.getElementById('floor').value = task.floor || '';
                document.getElementById('category').value = task.category || '';
                document.getElementById('cadence').value = task.cadence;
                document.getElementById('timeEstimate').value = task.time_estimate || 15;
                document.getElementById('effort').value = task.effort || 'Medium';
                document.getElementById('priority').value = task.priority || 100;

                // Open modal
                document.getElementById('taskModal').classList.add('show');
            } catch (error) {
                console.error('Error loading task:', error);
                showToast('Failed to load task', 'error');
            }
        };

        // Add task button
        document.getElementById('addTaskBtn').addEventListener('click', () => {
            document.getElementById('modalTitle').textContent = 'Add New Task';
            document.getElementById('taskForm').reset();
            document.getElementById('taskId').value = '';
            document.getElementById('taskModal').classList.add('show');
        });

        // Save task
        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const taskData = {
                task_name: document.getElementById('taskName').value,
                floor: document.getElementById('floor').value || null,
                category: document.getElementById('category').value || null,
                cadence: parseInt(document.getElementById('cadence').value),
                time_estimate: parseInt(document.getElementById('timeEstimate').value) || 15,
                effort: document.getElementById('effort').value,
                priority: parseInt(document.getElementById('priority').value) || 100
            };

            const taskId = document.getElementById('taskId').value;

            try {
                let result;
                
                if (taskId) {
                    // Update existing task
                    result = await tasks.update(taskId, taskData);
                    showToast('Task updated successfully!', 'success');
                } else {
                    // Create new task
                    result = await tasks.create(taskData);
                    showToast('Task created successfully! 🎉', 'success');
                }

                if (result.error) {
                    throw result.error;
                }

                closeTaskModal();
                await loadTasks();
            } catch (error) {
                console.error('Error saving task:', error);
                showToast('Failed to save task', 'error');
            }
        });

        // Confirm delete
        window.confirmDelete = (taskId, taskName) => {
            taskToDelete = taskId;
            document.getElementById('deleteTaskName').textContent = taskName;
            document.getElementById('deleteModal').classList.add('show');
        };

        // Delete task
        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!taskToDelete) return;

            try {
                const result = await tasks.delete(taskToDelete);
                
                if (result.error) {
                    throw result.error;
                }

                showToast('Task deleted', 'success');
                closeDeleteModal();
                await loadTasks();
            } catch (error) {
                console.error('Error deleting task:', error);
                showToast('Failed to delete task', 'error');
            }
        });

        // Filter tabs
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentFilter = tab.dataset.filter;
                renderTasks();
            });
        });

        // Search
        document.getElementById('searchInput').addEventListener('input', () => {
            renderTasks();
        });

        // Smart schedule button
        document.getElementById('smartScheduleBtn').addEventListener('click', () => {
            showToast('Smart scheduling coming soon! 🚀', 'info');
        });

        // Modal functions
        window.closeTaskModal = () => {
            document.getElementById('taskModal').classList.remove('show');
            document.getElementById('taskForm').reset();
        };

        window.closeDeleteModal = () => {
            document.getElementById('deleteModal').classList.remove('show');
            taskToDelete = null;
        };

        // Feedback functions
        window.showFeedbackModal = () => {
            document.getElementById('feedbackModal').classList.add('show');
        };

        window.closeFeedbackModal = () => {
            document.getElementById('feedbackModal').classList.remove('show');
            document.getElementById('feedbackForm').reset();
        };

        document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const type = document.getElementById('feedbackType').value;
            const message = document.getElementById('feedbackText').value;
            
            try {
                await feedback.submit({ type, message, page: 'cleaning' });
                showToast('Thanks for your feedback! 🙏', 'success');
                closeFeedbackModal();
            } catch (error) {
                console.error('Error submitting feedback:', error);
                showToast('Failed to send feedback', 'error');
            }
        });

        // Close modals on backdrop click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });

        // Initialize
        initApp();
        loadTasks();
    </script>
</body>
</html>