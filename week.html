<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Week - Cleaning Tracker</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <a href="index.html" class="back-btn">←</a>
                <h1>📅 This Week</h1>
                <div style="display:flex;gap:0.5rem;">
                    <button class="theme-toggle" id="themeToggle">🌙</button>
                    <button class="theme-toggle" onclick="signOut()" aria-label="Sign out" title="Sign Out">🚪</button>
                </div>
            </div>
            <div class="week-nav">
                <button class="nav-arrow" id="prevWeek">‹</button>
                <span class="week-range" id="weekRange">Loading...</span>
                <button class="nav-arrow" id="nextWeek">›</button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="main-nav">
            <a href="index.html" class="nav-link">
                <span class="nav-icon">🏠</span>
                <span class="nav-text">Home</span>
            </a>
            <a href="week.html" class="nav-link active">
                <span class="nav-icon">📅</span>
                <span class="nav-text">Week</span>
            </a>
            <a href="tasks.html" class="nav-link">
                <span class="nav-icon">📋</span>
                <span class="nav-text">Tasks</span>
            </a>
            <a href="stats.html" class="nav-link">
                <span class="nav-icon">📊</span>
                <span class="nav-text">Stats</span>
            </a>
        </nav>

        <!-- Settings Bar -->
        <div class="settings-bar">
            <div class="setting-item">
                <span class="setting-label">Daily Budget:</span>
                <span class="setting-value" id="dailyBudget">30 min</span>
                <button class="setting-btn" onclick="showSettingsModal()">⚙️</button>
            </div>
            <button class="btn btn-primary" onclick="smartSchedule()">
                ✨ Smart Schedule
            </button>
        </div>

        <!-- Week Grid -->
        <section class="week-grid" id="weekGrid">
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
        </section>

        <!-- Selected Day Details -->
        <section class="day-details" id="dayDetails" style="display:none;">
            <div class="day-details-header">
                <h2 id="selectedDayTitle">Today</h2>
                <div class="day-details-meta">
                    <span id="selectedDayMeta">0 tasks • 0 min</span>
                </div>
            </div>

            <!-- Smart Tip -->
            <div id="smartTip" style="display:none;background:var(--bg-secondary);padding:1rem;border-radius:var(--radius-md);margin-bottom:1rem;">
                <span style="font-size:1.25rem;margin-right:0.5rem;">💡</span>
                <span id="tipText" style="font-weight:500;"></span>
            </div>

            <!-- Schedule Columns -->
            <div class="schedule-columns">
                <!-- To Do -->
                <div class="schedule-column">
                    <div class="column-header column-todo">
                        <h3>To Do</h3>
                        <span class="column-count" id="todoCount">0</span>
                    </div>
                    <div class="column-content" id="todoColumn">
                        <div class="empty-state">
                            <div class="empty-state-icon">✨</div>
                            <p>No tasks scheduled</p>
                            <button class="btn btn-secondary btn-sm" onclick="showScheduleTaskPicker()">
                                Schedule Task
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Done -->
                <div class="schedule-column">
                    <div class="column-header column-done">
                        <h3>Done</h3>
                        <span class="column-count" id="doneCount">0</span>
                    </div>
                    <div class="column-content" id="doneColumn">
                        <div class="empty-state">
                            <div class="empty-state-icon">🎯</div>
                            <p>No completions yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- FAB -->
        <button class="fab" onclick="showScheduleTaskPicker()">
            <span>+</span>
        </button>

        <!-- Feedback FAB -->
        <button class="fab" onclick="showFeedbackModal()" 
                style="bottom:100px;background:var(--secondary);width:48px;height:48px;font-size:1.5rem;"
                aria-label="Send feedback" title="Send Feedback">
            💬
        </button>
    </div>

    <!-- Schedule Task Modal -->
    <div class="modal" id="scheduleTaskModal">
        <div class="modal-overlay" onclick="closeScheduleTaskPicker()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>Schedule Task</h3>
                <button class="modal-close" onclick="closeScheduleTaskPicker()">×</button>
            </div>
            <div class="modal-body" style="max-height:60vh;overflow-y:auto;">
                <div id="unscheduledTasksList" class="unscheduled-list">
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeScheduleTaskPicker()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-overlay" onclick="closeSettingsModal()"></div>
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3>Daily Time Budget</h3>
                <button class="modal-close" onclick="closeSettingsModal()">×</button>
            </div>
            <form id="settingsForm" onsubmit="saveSettings(event)">
                <div class="form-group">
                    <label for="dailyMinutes">Minutes per day</label>
                    <select id="dailyMinutes">
                        <option value="15">15 minutes</option>
                        <option value="30" selected>30 minutes</option>
                        <option value="45">45 minutes</option>
                        <option value="60">1 hour</option>
                        <option value="90">1.5 hours</option>
                        <option value="120">2 hours</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeSettingsModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Feedback Modal -->
    <div class="modal" id="feedbackModal">
        <div class="modal-overlay" onclick="closeFeedbackModal()"></div>
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3>Send Feedback</h3>
                <button class="modal-close" onclick="closeFeedbackModal()">×</button>
            </div>
            <form id="feedbackForm" onsubmit="submitFeedback(event)">
                <div class="form-group">
                    <label>What kind of feedback?</label>
                    <select id="feedbackType" required>
                        <option value="bug">🐛 Bug Report</option>
                        <option value="feature">💡 Feature Request</option>
                        <option value="feedback">💬 General Feedback</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="feedbackText">Tell us more</label>
                    <textarea id="feedbackText" rows="4" required 
                              style="width:100%;padding:0.75rem;border:2px solid var(--border-color);border-radius:var(--radius-sm);font-family:inherit;font-size:1rem;"
                              placeholder="Be as detailed as you'd like..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeFeedbackModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Feedback</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="js/config.js"></script>
    <script type="module" src="js/api.js"></script>
    <script type="module" src="js/schedule.js"></script>
    
    <!-- Auth Check -->
    <script type="module">
        import { supabase } from './js/api.js';
        
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = '/login.html';
                return;
            }
        }
        
        checkAuth();
        
        window.signOut = async () => {
            await supabase.auth.signOut();
            window.location.href = '/login.html';
        };
    </script>
    
    <!-- Feedback Functions -->
    <script type="module">
        import { supabase } from './js/api.js';
        import { showToast } from './js/schedule.js';
        
        window.showFeedbackModal = () => {
            document.getElementById('feedbackModal').classList.add('show');
        };

        window.closeFeedbackModal = () => {
            document.getElementById('feedbackModal').classList.remove('show');
            document.getElementById('feedbackForm').reset();
        };

        window.submitFeedback = async (event) => {
            event.preventDefault();
            
            const type = document.getElementById('feedbackType').value;
            const text = document.getElementById('feedbackText').value;
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                
                await supabase.from('feedback').insert([{
                    user_id: user.id,
                    user_email: user.email,
                    type: type,
                    message: text,
                    page: window.location.pathname
                }]);
                
                showToast('Thanks for your feedback! 🙏');
                closeFeedbackModal();
            } catch (error) {
                console.error('Error submitting feedback:', error);
                showToast('Error sending feedback', 'error');
            }
        };
    </script>
    
    <!-- Load Week View -->
    <script type="module">
        import { loadWeekView, initWeekNavigation } from './js/schedule.js';
        
        document.addEventListener('DOMContentLoaded', async () => {
            await loadWeekView();
            initWeekNavigation();
        });
    </script>
</body>
</html>