<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Cadence</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="page-wrapper">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <a href="index.html" class="logo">Cadence</a>
                    
                    <nav class="nav-menu" id="navMenu">
                        <a href="index.html" class="nav-link active">Dashboard</a>
                        <a href="cleaning.html" class="nav-link">Cleaning</a>
                        <a href="settings.html" class="nav-link">Settings</a>
                        <a href="components.html" class="nav-link">Components</a>
                    </nav>

                    <button class="btn btn-secondary" id="logoutBtn" style="display: none;">
                        <span>Logout</span>
                        <span>üö™</span>
                    </button>

                    <button class="mobile-nav-toggle" id="mobileToggle">‚ò∞</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="content-wrapper">
            <div class="container">
                <!-- Welcome Section -->
                <section class="welcome-section">
                    <div class="welcome-content">
                        <h1 class="welcome-title">Welcome back, <span id="userName">User</span></h1>
                        <p class="welcome-subtitle">Here's what's happening with your home today</p>
                    </div>
                    <a href="cleaning.html" class="btn btn-primary">
                        <span>View All Tasks</span>
                        <span>‚Üí</span>
                    </a>
                </section>

                <!-- Stats Overview -->
                <section class="stats-section">
                    <div class="stats-grid">
                        <!-- Overdue Tasks -->
                        <div class="stat-card glass-card" style="border-left: 3px solid var(--danger-coral);">
                            <div class="stat-icon" style="color: var(--danger-coral);">üî¥</div>
                            <div class="stat-content">
                                <div class="stat-value" id="overdueCount">
                                    <div class="skeleton skeleton-text"></div>
                                </div>
                                <div class="stat-label">Overdue Tasks</div>
                                <div class="stat-change">Need attention</div>
                            </div>
                        </div>

                        <!-- Due Soon -->
                        <div class="stat-card glass-card" style="border-left: 3px solid var(--warning-amber);">
                            <div class="stat-icon" style="color: var(--warning-amber);">üü°</div>
                            <div class="stat-content">
                                <div class="stat-value" id="dueSoonCount">
                                    <div class="skeleton skeleton-text"></div>
                                </div>
                                <div class="stat-label">Due Soon</div>
                                <div class="stat-change">Next 3 days</div>
                            </div>
                        </div>

                        <!-- On Track -->
                        <div class="stat-card glass-card" style="border-left: 3px solid var(--success-green);">
                            <div class="stat-icon" style="color: var(--success-green);">üü¢</div>
                            <div class="stat-content">
                                <div class="stat-value" id="onTrackCount">
                                    <div class="skeleton skeleton-text"></div>
                                </div>
                                <div class="stat-label">On Track</div>
                                <div class="stat-change">Looking good!</div>
                            </div>
                        </div>

                        <!-- Value Saved -->
                        <div class="stat-card glass-card-hover">
                            <div class="stat-icon" style="color: var(--primary-gold);">üí∞</div>
                            <div class="stat-content">
                                <div class="stat-value" id="valueSaved">
                                    <div class="skeleton skeleton-text"></div>
                                </div>
                                <div class="stat-label">Value This Week</div>
                                <div class="stat-change" id="completionsText">Based on completions</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Quick Actions -->
                <section class="quick-actions-section" style="margin-bottom: var(--space-12);">
                    <div class="section-header">
                        <h2>Quick Actions</h2>
                    </div>
                    <div class="quick-actions-grid">
                        <a href="cleaning.html?action=add" class="action-card glass-card-hover">
                            <div class="action-icon">‚ûï</div>
                            <div class="action-content">
                                <h3>Add Task</h3>
                                <p>Create a new cleaning task</p>
                            </div>
                        </a>
                        <a href="cleaning.html?view=week" class="action-card glass-card-hover">
                            <div class="action-icon">üìÖ</div>
                            <div class="action-content">
                                <h3>View Week</h3>
                                <p>See your weekly schedule</p>
                            </div>
                        </a>
                        <a href="cleaning.html?action=schedule" class="action-card glass-card-hover">
                            <div class="action-icon">‚ö°</div>
                            <div class="action-content">
                                <h3>Smart Schedule</h3>
                                <p>Auto-schedule your week</p>
                            </div>
                        </a>
                    </div>
                </section>

                <!-- Recent Activity -->
                <section class="recent-activity-section">
                    <div class="section-header">
                        <h2>Recent Completions</h2>
                        <a href="cleaning.html" class="btn btn-secondary btn-sm">View All</a>
                    </div>
                    <div id="recentCompletions" class="activity-list">
                        <!-- Loading skeletons -->
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                    </div>
                </section>

                <!-- Tips & Insights -->
                <section class="insights-section" style="margin-top: var(--space-12);">
                    <div class="section-header">
                        <h2>Smart Tips</h2>
                    </div>
                    <div class="insights-grid">
                        <div class="insight-card glass-card">
                            <div class="insight-icon">üí°</div>
                            <div class="insight-content">
                                <h3>Efficiency Tip</h3>
                                <p id="efficiencyTip">Group tasks by floor to minimize movement and save time.</p>
                            </div>
                        </div>
                        <div class="insight-card glass-card">
                            <div class="insight-icon">üéØ</div>
                            <div class="insight-content">
                                <h3>Focus Area</h3>
                                <p id="focusArea">Check your overdue tasks to get back on track.</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Feedback Button -->
    <button class="fab" onclick="showFeedbackModal()" title="Send Feedback">
        üí¨
    </button>

    <!-- Feedback Modal -->
    <div class="modal" id="feedbackModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Send Feedback</h3>
                <button class="modal-close" onclick="closeFeedbackModal()">√ó</button>
            </div>
            <form id="feedbackForm">
                <div class="form-group">
                    <label class="form-label">What kind of feedback?</label>
                    <select id="feedbackType" class="form-input" required>
                        <option value="bug">üêõ Bug Report</option>
                        <option value="feature">üí° Feature Request</option>
                        <option value="feedback">üí¨ General Feedback</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tell us more</label>
                    <textarea 
                        id="feedbackText" 
                        class="form-input" 
                        rows="4" 
                        required
                        placeholder="Be as detailed as you'd like..."
                    ></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeFeedbackModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Send Feedback
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initAuthCheck } from './js/auth.js';
        import { stats, settings, feedback } from './js/api.js';
        import { 
            showToast, 
            formatRelativeTime, 
            formatCurrency,
            initApp 
        } from './js/app.js';

        // Check authentication
        const user = await initAuthCheck();
        
        // Show logout button
        document.getElementById('logoutBtn').style.display = 'flex';

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load user settings and stats
                const [dashboardStats, userSettings] = await Promise.all([
                    stats.getDashboard(),
                    settings.get()
                ]);

                // Update user name
                if (userSettings.data) {
                    document.getElementById('userName').textContent = 
                        userSettings.data.user_name || 'there';
                }

                // Update stats
                if (dashboardStats.data) {
                    const data = dashboardStats.data;
                    
                    document.getElementById('overdueCount').textContent = data.overdueCount;
                    document.getElementById('dueSoonCount').textContent = data.dueSoonCount;
                    document.getElementById('onTrackCount').textContent = data.onTrackCount;
                    document.getElementById('valueSaved').textContent = formatCurrency(data.valueSaved || 0);
                    document.getElementById('completionsText').textContent = 
                        `${data.completionsThisWeek} ${data.completionsThisWeek === 1 ? 'task' : 'tasks'} completed`;

                    // Load recent completions
                    loadRecentCompletions(data.recentCompletions || []);

                    // Update tips based on data
                    updateSmartTips(data);
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('Failed to load dashboard data', 'error');
            }
        }

        // Load recent completions
        function loadRecentCompletions(completions) {
            const container = document.getElementById('recentCompletions');
            
            if (completions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3 class="empty-state-title">No completions yet</h3>
                        <p class="empty-state-text">Start completing tasks to see your progress here!</p>
                        <a href="cleaning.html" class="btn btn-primary" style="margin-top: var(--space-4);">
                            View Tasks
                        </a>
                    </div>
                `;
                return;
            }

            container.innerHTML = completions.slice(0, 5).map(completion => `
                <div class="activity-item glass-card">
                    <div class="activity-icon">‚úì</div>
                    <div class="activity-content">
                        <h4>${completion.task_name}</h4>
                        <p>${completion.floor || 'N/A'} ‚Ä¢ ${completion.category || 'General'}</p>
                    </div>
                    <div class="activity-meta">
                        <span class="activity-time">${formatRelativeTime(completion.completed_at)}</span>
                        <span class="activity-value">${completion.time_minutes || 15} min</span>
                    </div>
                </div>
            `).join('');
        }

        // Update smart tips based on data
        function updateSmartTips(data) {
            const efficiencyTip = document.getElementById('efficiencyTip');
            const focusArea = document.getElementById('focusArea');

            // Efficiency tip
            if (data.completionsThisWeek >= 10) {
                efficiencyTip.textContent = "You're crushing it! Keep up the great momentum.";
            } else if (data.completionsThisWeek >= 5) {
                efficiencyTip.textContent = "You're making great progress this week. A few more tasks and you'll hit your goal!";
            } else {
                efficiencyTip.textContent = "Group tasks by floor to minimize movement and save time.";
            }

            // Focus area
            if (data.overdueCount > 0) {
                focusArea.textContent = `You have ${data.overdueCount} overdue ${data.overdueCount === 1 ? 'task' : 'tasks'}. Tackle these first to get back on track!`;
            } else if (data.dueSoonCount > 0) {
                focusArea.textContent = `${data.dueSoonCount} ${data.dueSoonCount === 1 ? 'task is' : 'tasks are'} due soon. Stay ahead of the curve!`;
            } else {
                focusArea.textContent = "Everything is on track! Great job staying organized.";
            }
        }

        // Feedback modal functions
        window.showFeedbackModal = () => {
            document.getElementById('feedbackModal').classList.add('show');
        };

        window.closeFeedbackModal = () => {
            document.getElementById('feedbackModal').classList.remove('show');
            document.getElementById('feedbackForm').reset();
        };

        // Submit feedback
        document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const type = document.getElementById('feedbackType').value;
            const message = document.getElementById('feedbackText').value;
            
            try {
                await feedback.submit({ type, message, page: 'dashboard' });
                showToast('Thanks for your feedback! üôè', 'success');
                closeFeedbackModal();
            } catch (error) {
                console.error('Error submitting feedback:', error);
                showToast('Failed to send feedback', 'error');
            }
        });

        // Close modal on backdrop click
        document.getElementById('feedbackModal').addEventListener('click', (e) => {
            if (e.target.id === 'feedbackModal') {
                closeFeedbackModal();
            }
        });

        // Initialize app and load data
        initApp();
        loadDashboard();
    </script>
</body>
</html>