<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome - Cadence</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-content">
                <h1>üè† Welcome to Cadence!</h1>
            </div>
        </header>

        <section class="section">
            <!-- Step 1: Name -->
            <div id="step1" class="onboarding-step">
                <h2 style="margin-bottom:1rem;">What should we call you?</h2>
                <div class="form-group">
                    <input type="text" id="userName" placeholder="Your name" autofocus style="font-size:1.125rem;">
                </div>
                <button class="btn btn-primary" onclick="nextStep(1)" style="margin-top:1rem;">Next ‚Üí</button>
            </div>

            <!-- Step 2: Tasks -->
            <div id="step2" class="onboarding-step" style="display:none;">
                <h2 style="margin-bottom:0.5rem;">Let's add your first tasks</h2>
                <p style="color:var(--text-secondary);margin-bottom:1.5rem;">
                    Check the ones you want to track:
                </p>
                
                <div style="display:flex;flex-direction:column;gap:1rem;">
                    <label class="task-template" style="display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--bg-primary);border-radius:var(--radius-md);cursor:pointer;border:2px solid transparent;transition:var(--transition);">
                        <input type="checkbox" value='{"task_name":"Clean kitchen counters","floor":"First Floor","category":"Kitchen","cadence":1,"time_estimate":10,"effort":"Low"}' checked>
                        <div style="flex:1;">
                            <div style="font-weight:600;">Clean kitchen counters</div>
                            <div style="font-size:0.875rem;color:var(--text-secondary);">Daily ‚Ä¢ 10 min ‚Ä¢ First Floor</div>
                        </div>
                    </label>
                    
                    <label class="task-template" style="display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--bg-primary);border-radius:var(--radius-md);cursor:pointer;border:2px solid transparent;transition:var(--transition);">
                        <input type="checkbox" value='{"task_name":"Vacuum living room","floor":"First Floor","category":"Living Room","cadence":3,"time_estimate":15,"effort":"Medium"}' checked>
                        <div style="flex:1;">
                            <div style="font-weight:600;">Vacuum living room</div>
                            <div style="font-size:0.875rem;color:var(--text-secondary);">Every 3 days ‚Ä¢ 15 min ‚Ä¢ First Floor</div>
                        </div>
                    </label>
                    
                    <label class="task-template" style="display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--bg-primary);border-radius:var(--radius-md);cursor:pointer;border:2px solid transparent;transition:var(--transition);">
                        <input type="checkbox" value='{"task_name":"Clean bathroom sink","floor":"First Floor","category":"Bathroom","cadence":2,"time_estimate":5,"effort":"Low"}' checked>
                        <div style="flex:1;">
                            <div style="font-weight:600;">Clean bathroom sink</div>
                            <div style="font-size:0.875rem;color:var(--text-secondary);">Every 2 days ‚Ä¢ 5 min ‚Ä¢ First Floor</div>
                        </div>
                    </label>
                    
                    <label class="task-template" style="display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--bg-primary);border-radius:var(--radius-md);cursor:pointer;border:2px solid transparent;transition:var(--transition);">
                        <input type="checkbox" value='{"task_name":"Mop kitchen floor","floor":"First Floor","category":"Kitchen","cadence":7,"time_estimate":20,"effort":"Medium"}'>
                        <div style="flex:1;">
                            <div style="font-weight:600;">Mop kitchen floor</div>
                            <div style="font-size:0.875rem;color:var(--text-secondary);">Weekly ‚Ä¢ 20 min ‚Ä¢ First Floor</div>
                        </div>
                    </label>
                    
                    <label class="task-template" style="display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--bg-primary);border-radius:var(--radius-md);cursor:pointer;border:2px solid transparent;transition:var(--transition);">
                        <input type="checkbox" value='{"task_name":"Clean toilet","floor":"First Floor","category":"Bathroom","cadence":3,"time_estimate":10,"effort":"Low"}' checked>
                        <div style="flex:1;">
                            <div style="font-weight:600;">Clean toilet</div>
                            <div style="font-size:0.875rem;color:var(--text-secondary);">Every 3 days ‚Ä¢ 10 min ‚Ä¢ First Floor</div>
                        </div>
                    </label>
                    
                    <label class="task-template" style="display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--bg-primary);border-radius:var(--radius-md);cursor:pointer;border:2px solid transparent;transition:var(--transition);">
                        <input type="checkbox" value='{"task_name":"Wipe down fridge","floor":"First Floor","category":"Kitchen","cadence":14,"time_estimate":15,"effort":"Medium"}'>
                        <div style="flex:1;">
                            <div style="font-weight:600;">Wipe down fridge</div>
                            <div style="font-size:0.875rem;color:var(--text-secondary);">Bi-weekly ‚Ä¢ 15 min ‚Ä¢ First Floor</div>
                        </div>
                    </label>

                    <label class="task-template" style="display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--bg-primary);border-radius:var(--radius-md);cursor:pointer;border:2px solid transparent;transition:var(--transition);">
                        <input type="checkbox" value='{"task_name":"Dust bedroom","floor":"Second Floor","category":"Bedroom","cadence":7,"time_estimate":10,"effort":"Low"}'>
                        <div style="flex:1;">
                            <div style="font-weight:600;">Dust bedroom</div>
                            <div style="font-size:0.875rem;color:var(--text-secondary);">Weekly ‚Ä¢ 10 min ‚Ä¢ Second Floor</div>
                        </div>
                    </label>

                    <label class="task-template" style="display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--bg-primary);border-radius:var(--radius-md);cursor:pointer;border:2px solid transparent;transition:var(--transition);">
                        <input type="checkbox" value='{"task_name":"Take out trash","floor":"First Floor","category":"Kitchen","cadence":2,"time_estimate":5,"effort":"Low"}' checked>
                        <div style="flex:1;">
                            <div style="font-weight:600;">Take out trash</div>
                            <div style="font-size:0.875rem;color:var(--text-secondary);">Every 2 days ‚Ä¢ 5 min ‚Ä¢ First Floor</div>
                        </div>
                    </label>
                </div>
                
                <button class="btn btn-primary" onclick="nextStep(2)" style="margin-top:2rem;width:100%;">Next ‚Üí</button>
            </div>

            <!-- Step 3: Time Budget -->
            <div id="step3" class="onboarding-step" style="display:none;">
                <h2 style="margin-bottom:0.5rem;">How much time per day?</h2>
                <p style="color:var(--text-secondary);margin-bottom:1.5rem;">
                    This helps us schedule tasks smartly throughout your week
                </p>
                
                <div class="form-group">
                    <select id="dailyMinutes" style="font-size:1.125rem;padding:1rem;">
                        <option value="15">15 minutes per day</option>
                        <option value="30" selected>30 minutes per day</option>
                        <option value="45">45 minutes per day</option>
                        <option value="60">1 hour per day</option>
                        <option value="90">1.5 hours per day</option>
                    </select>
                </div>
                
                <button class="btn btn-primary" onclick="finishOnboarding()" style="margin-top:2rem;width:100%;">
                    Let's Go! üöÄ
                </button>
            </div>

            <div id="loadingState" style="display:none;text-align:center;padding:3rem;">
                <div class="spinner" style="margin:0 auto 1rem;"></div>
                <p style="color:var(--text-secondary);">Setting up your account...</p>
            </div>
        </section>
    </div>

    <div class="toast" id="toast"></div>

    <script type="module">
        import { createTask, updateSetting } from './js/api.js';
        import { SUPABASE_URL, SUPABASE_KEY } from './js/config.js';
        
        const showToast = (message) => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };

        // Simple Supabase wrapper
        const supabase = {
            from: (table) => ({
                update: async (values) => ({
                    eq: async (column, value) => {
                        const accessToken = localStorage.getItem('supabase.auth.token');
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${column}=eq.${value}`, {
                            method: 'PATCH',
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${accessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(values)
                        });
                        return { error: response.ok ? null : await response.json() };
                    }
                })
            }),
            auth: {
                getUser: async () => {
                    const accessToken = localStorage.getItem('supabase.auth.token');
                    const response = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });
                    const user = await response.json();
                    return { data: { user } };
                }
            }
        };
        
        let userName = '';
        let selectedTasks = [];
        
        window.nextStep = async (currentStep) => {
            if (currentStep === 1) {
                userName = document.getElementById('userName').value.trim();
                if (!userName) {
                    showToast('Please enter your name');
                    return;
                }
                
                // Save name
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    await supabase.from('settings')
                        .update({ user_name: userName })
                        .eq('user_id', user.id);
                } catch (error) {
                    console.error('Error saving name:', error);
                }
                
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
            } else if (currentStep === 2) {
                const checkboxes = document.querySelectorAll('.task-template input:checked');
                selectedTasks = Array.from(checkboxes).map(cb => JSON.parse(cb.value));
                
                if (selectedTasks.length === 0) {
                    showToast('Please select at least one task');
                    return;
                }
                
                document.getElementById('step2').style.display = 'none';
                document.getElementById('step3').style.display = 'block';
            }
        };
        
        window.finishOnboarding = async () => {
            const dailyMinutes = parseInt(document.getElementById('dailyMinutes').value);
            
            // Hide form, show loading
            document.getElementById('step3').style.display = 'none';
            document.getElementById('loadingState').style.display = 'block';
            
            try {
                // Create all selected tasks
                for (const task of selectedTasks) {
                    await createTask(task);
                }
                
                // Save settings
                await updateSetting('daily_minutes', dailyMinutes);
                await updateSetting('onboarding_completed', true);
                
                showToast('Welcome to Cadence! üéâ');
                
                setTimeout(() => {
                    window.location.href = './index.html';
                }, 1500);
            } catch (error) {
                console.error('Error finishing onboarding:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('step3').style.display = 'block';
                showToast('Something went wrong. Please try again.');
            }
        };

        // Add visual feedback for checkboxes
        document.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                const label = e.target.closest('.task-template');
                if (e.target.checked) {
                    label.style.borderColor = 'var(--primary)';
                    label.style.background = 'rgba(102, 126, 234, 0.05)';
                } else {
                    label.style.borderColor = 'transparent';
                    label.style.background = 'var(--bg-primary)';
                }
            }
        });
    </script>
</body>
</html>