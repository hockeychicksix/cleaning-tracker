<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stats - Cleaning Tracker</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header header-gradient">
            <div class="header-content">
                <a href="index.html" class="back-btn">←</a>
                <h1>📊 Your Stats</h1>
                <div style="display:flex;gap:0.5rem;">
                    <button class="theme-toggle" id="themeToggle">🌙</button>
                    <button class="theme-toggle" onclick="signOut()" aria-label="Sign out" title="Sign Out">🚪</button>
                </div>
            </div>
            <p class="header-subtitle">Track your progress and celebrate wins</p>
        </header>

        <!-- Navigation -->
        <nav class="main-nav">
            <a href="index.html" class="nav-link">
                <span class="nav-icon">🏠</span>
                <span class="nav-text">Home</span>
            </a>
            <a href="week.html" class="nav-link">
                <span class="nav-icon">📅</span>
                <span class="nav-text">Week</span>
            </a>
            <a href="tasks.html" class="nav-link">
                <span class="nav-icon">📋</span>
                <span class="nav-text">Tasks</span>
            </a>
            <a href="stats.html" class="nav-link active">
                <span class="nav-icon">📊</span>
                <span class="nav-text">Stats</span>
            </a>
        </nav>

        <!-- Value Created -->
        <section class="value-card">
            <div class="value-content">
                <h2 class="value-title">Value Created</h2>
                <div class="value-amount">$<span id="totalValue">0</span></div>
                <p class="value-subtitle">Based on time saved at $35/hour</p>
            </div>
            <div class="value-stats">
                <div class="value-stat">
                    <div class="value-stat-value" id="hoursCompleted">0</div>
                    <div class="value-stat-label">Hours</div>
                </div>
                <div class="value-stat">
                    <div class="value-stat-value" id="tasksCompleted">0</div>
                    <div class="value-stat-label">Tasks</div>
                </div>
                <div class="value-stat">
                    <div class="value-stat-value" id="currentStreak">0</div>
                    <div class="value-stat-label">Day Streak 🔥</div>
                </div>
            </div>
        </section>

        <!-- Quick Stats Grid -->
        <section class="stats-grid stats-grid-detailed">
            <div class="stat-card-detailed">
                <div class="stat-card-icon">📅</div>
                <div class="stat-card-content">
                    <div class="stat-card-value" id="completedThisWeek">0</div>
                    <div class="stat-card-label">This Week</div>
                </div>
            </div>
            <div class="stat-card-detailed">
                <div class="stat-card-icon">📆</div>
                <div class="stat-card-content">
                    <div class="stat-card-value" id="completedThisMonth">0</div>
                    <div class="stat-card-label">This Month</div>
                </div>
            </div>
            <div class="stat-card-detailed">
                <div class="stat-card-icon">⏱️</div>
                <div class="stat-card-content">
                    <div class="stat-card-value" id="avgTimePerTask">0</div>
                    <div class="stat-card-label">Avg Time</div>
                </div>
            </div>
            <div class="stat-card-detailed">
                <div class="stat-card-icon">🏆</div>
                <div class="stat-card-content">
                    <div class="stat-card-value" id="longestStreak">0</div>
                    <div class="stat-card-label">Best Streak</div>
                </div>
            </div>
        </section>

        <!-- Top Categories -->
        <section class="section">
            <div class="section-header">
                <h2>Top Categories</h2>
            </div>
            <div id="topCategories" class="category-list">
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
            </div>
        </section>

        <!-- Recent Activity -->
        <section class="section">
            <div class="section-header">
                <h2>Recent Completions</h2>
            </div>
            <div id="recentCompletions" class="activity-list">
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
            </div>
        </section>

        <!-- Feedback FAB -->
        <button class="fab" onclick="showFeedbackModal()" 
                style="bottom:1.5rem;right:1.5rem;background:var(--secondary);width:56px;height:56px;font-size:1.5rem;"
                aria-label="Send feedback" title="Send Feedback">
            💬
        </button>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Feedback Modal -->
    <div class="modal" id="feedbackModal">
        <div class="modal-overlay" onclick="closeFeedbackModal()"></div>
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3>Send Feedback</h3>
                <button class="modal-close" onclick="closeFeedbackModal()">×</button>
            </div>
            <form id="feedbackForm" onsubmit="submitFeedback(event)">
                <div class="form-group">
                    <label>What kind of feedback?</label>
                    <select id="feedbackType" required>
                        <option value="bug">🐛 Bug Report</option>
                        <option value="feature">💡 Feature Request</option>
                        <option value="feedback">💬 General Feedback</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="feedbackText">Tell us more</label>
                    <textarea id="feedbackText" rows="4" required 
                              style="width:100%;padding:0.75rem;border:2px solid var(--border-color);border-radius:var(--radius-sm);font-family:inherit;font-size:1rem;"
                              placeholder="Be as detailed as you'd like..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeFeedbackModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Feedback</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="js/config.js"></script>
    <script type="module" src="js/api.js"></script>
    <script type="module" src="js/app.js"></script>
    
    <!-- Auth Check -->
    <script type="module">
        import { SUPABASE_URL, SUPABASE_KEY } from './js/config.js';
        
        async function checkAuth() {
            const accessToken = localStorage.getItem('supabase.auth.token');
            if (!accessToken) {
                window.location.href = './login.html';
                return;
            }
        }
        
        checkAuth();
        
        window.signOut = () => {
            localStorage.removeItem('supabase.auth.token');
            window.location.href = './login.html';
        };
    </script>
    
    <!-- Feedback Functions -->
    <script type="module">
        import { SUPABASE_URL, SUPABASE_KEY } from './js/config.js';
        import { showToast } from './js/app.js';
        
        window.showFeedbackModal = () => {
            document.getElementById('feedbackModal').classList.add('show');
        };

        window.closeFeedbackModal = () => {
            document.getElementById('feedbackModal').classList.remove('show');
            document.getElementById('feedbackForm').reset();
        };

        window.submitFeedback = async (event) => {
            event.preventDefault();
            
            const type = document.getElementById('feedbackType').value;
            const text = document.getElementById('feedbackText').value;
            
            try {
                const accessToken = localStorage.getItem('supabase.auth.token');
                
                const userResponse = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const user = await userResponse.json();
                
                await fetch(`${SUPABASE_URL}/rest/v1/feedback`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        user_id: user.id,
                        user_email: user.email,
                        type: type,
                        message: text,
                        page: window.location.pathname
                    })
                });
                
                showToast('Thanks for your feedback! 🙏');
                closeFeedbackModal();
            } catch (error) {
                console.error('Error submitting feedback:', error);
                showToast('Error sending feedback', 'error');
            }
        };
    </script>
    
    <!-- Load Stats -->
    <script type="module">
        import { loadStats, loadTopCategories, loadRecentCompletions } from './js/app.js';
        
        document.addEventListener('DOMContentLoaded', async () => {
            await loadStats();
            await loadTopCategories();
            await loadRecentCompletions();
        });
    </script>
</body>
</html>