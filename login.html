<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Cadence</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="login-wrapper">
        <!-- Animated Background Elements -->
        <div class="bg-orb orb-1"></div>
        <div class="bg-orb orb-2"></div>
        <div class="bg-orb orb-3"></div>
        
        <div class="login-container">
            <!-- Logo Section -->
            <div class="login-header">
                <div class="login-logo">Cadence</div>
                <p class="login-tagline">Your intelligent home operations system</p>
            </div>

            <!-- Login Card -->
            <div class="login-card glass-card-elevated">
                <h2 class="login-title" id="authTitle">Welcome Back</h2>
                <p class="login-subtitle" id="authSubtitle">Sign in to continue to your dashboard</p>

                <!-- Error Message -->
                <div id="errorMessage" class="error-message" style="display: none;"></div>

                <!-- Loading State -->
                <div id="loadingState" class="loading-state" style="display: none;">
                    <div class="spinner"></div>
                    <p>Authenticating...</p>
                </div>

                <!-- Auth Form -->
                <form class="login-form" id="authForm">
                    <div class="form-group">
                        <label class="form-label" for="email">Email Address</label>
                        <input 
                            type="email" 
                            id="email" 
                            class="form-input" 
                            placeholder="your@email.com"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="password">Password</label>
                        <input 
                            type="password" 
                            id="password" 
                            class="form-input" 
                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                            required
                            minlength="6"
                        >
                    </div>

                    <div class="form-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="remember">
                            <span class="checkbox-custom"></span>
                            <span class="checkbox-text">Remember me</span>
                        </label>
                        <a href="#" class="forgot-link" id="forgotPasswordLink">Forgot password?</a>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block btn-lg" id="authButton">
                        <span id="authButtonText">Sign In</span>
                        <span class="btn-arrow">â†’</span>
                    </button>
                </form>

                <div class="signup-link">
                    <span id="authTogglePrompt">Don't have an account?</span>
                    <a href="#" id="authToggleLink">Create Account</a>
                </div>
            </div>

            <!-- Footer -->
            <div class="login-footer">
                <p>&copy; 2025 Cadence. Making home management effortless.</p>
                <div class="footer-links">
                    <a href="#">Privacy</a>
                    <a href="#">Terms</a>
                    <a href="#">Support</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal" id="forgotPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Reset Password</h3>
                <button class="modal-close" onclick="closeForgotPasswordModal()">Ã—</button>
            </div>
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label class="form-label">Enter your email address</label>
                    <input 
                        type="email" 
                        id="resetEmail" 
                        class="form-input" 
                        placeholder="your@email.com"
                        required
                    >
                    <small class="form-help">We'll send you a link to reset your password</small>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeForgotPasswordModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Send Reset Link
                    </button>
                </div>
            </form>
            <div id="resetSuccess" class="success-message" style="display: none;"></div>
            <div id="resetError" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { auth } from './js/auth.js';
        import { settings } from './js/api.js';
        import { showToast } from './js/app.js';

        let isSignUp = false;

        // Check if already logged in
        (async () => {
            const { data: { session } } = await auth.getSession();
            if (session) {
                window.location.href = './index.html';
            }
        })();

        // Toggle between sign in and sign up
        function toggleAuthMode() {
            isSignUp = !isSignUp;
            
            document.getElementById('authTitle').textContent = isSignUp ? 'Create Account' : 'Welcome Back';
            document.getElementById('authSubtitle').textContent = isSignUp 
                ? 'Start managing your home smarter' 
                : 'Sign in to continue to your dashboard';
            document.getElementById('authButtonText').textContent = isSignUp ? 'Create Account' : 'Sign In';
            document.getElementById('authTogglePrompt').textContent = isSignUp 
                ? 'Already have an account?' 
                : "Don't have an account?";
            document.getElementById('authToggleLink').textContent = isSignUp ? 'Sign In' : 'Create Account';
            
            // Hide error message
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Auth form submission
        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // Show loading state
            const loadingState = document.getElementById('loadingState');
            const authForm = document.getElementById('authForm');
            const errorMessage = document.getElementById('errorMessage');
            
            loadingState.style.display = 'block';
            authForm.style.display = 'none';
            errorMessage.style.display = 'none';
            
            try {
                let result;
                
                if (isSignUp) {
                    // Sign up
                    result = await auth.signUp(email, password);
                    
                    if (result.error) {
                        throw result.error;
                    }
                    
                    // Create default settings for new user
                    await settings.create({
                        user_name: email.split('@')[0],
                        hourly_rate: 35,
                        daily_minutes: 30,
                        onboarding_completed: false
                    });
                    
                    showToast('Account created! Welcome to Cadence ðŸŽ‰', 'success');
                    
                    // Redirect to dashboard
                    setTimeout(() => {
                        window.location.href = './index.html';
                    }, 1000);
                    
                } else {
                    // Sign in
                    result = await auth.signIn(email, password);
                    
                    if (result.error) {
                        throw result.error;
                    }
                    
                    showToast('Welcome back! ðŸ‘‹', 'success');
                    
                    // Redirect to dashboard
                    setTimeout(() => {
                        window.location.href = './index.html';
                    }, 500);
                }
                
            } catch (error) {
                console.error('Auth error:', error);
                
                loadingState.style.display = 'none';
                authForm.style.display = 'block';
                errorMessage.style.display = 'block';
                errorMessage.textContent = error.message || 'Authentication failed. Please try again.';
            }
        });

        // Toggle link handler
        document.getElementById('authToggleLink').addEventListener('click', (e) => {
            e.preventDefault();
            toggleAuthMode();
        });

        // Forgot password
        document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('forgotPasswordModal').classList.add('show');
        });

        // Forgot password form
        document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('resetEmail').value;
            const resetError = document.getElementById('resetError');
            const resetSuccess = document.getElementById('resetSuccess');
            
            resetError.style.display = 'none';
            resetSuccess.style.display = 'none';
            
            try {
                const result = await auth.resetPassword(email);
                
                if (result.error) {
                    throw result.error;
                }
                
                resetSuccess.style.display = 'block';
                resetSuccess.textContent = 'Password reset email sent! Check your inbox.';
                
                setTimeout(() => {
                    closeForgotPasswordModal();
                }, 3000);
                
            } catch (error) {
                resetError.style.display = 'block';
                resetError.textContent = error.message || 'Failed to send reset email. Please try again.';
            }
        });

        // Close modal functions
        window.closeForgotPasswordModal = () => {
            document.getElementById('forgotPasswordModal').classList.remove('show');
            document.getElementById('forgotPasswordForm').reset();
            document.getElementById('resetError').style.display = 'none';
            document.getElementById('resetSuccess').style.display = 'none';
        };

        // Close modal on backdrop click
        document.getElementById('forgotPasswordModal').addEventListener('click', (e) => {
            if (e.target.id === 'forgotPasswordModal') {
                closeForgotPasswordModal();
            }
        });
    </script>
</body>
</html>